import os
import random
from telegram import Update, ReplyKeyboardMarkup
from telegram.ext import ApplicationBuilder, CommandHandler, MessageHandler, ContextTypes, filters

# ====== –ß–∏—Ç–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è ======
TOKEN = os.getenv("TOKEN")
WEBHOOK_BASE = os.getenv("WEBHOOK_BASE")
CHANNEL_ID = os.getenv("CHANNEL_ID")
MODE = os.getenv("MODE", "polling")
PORT = int(os.getenv("PORT", 10000))

if not TOKEN:
    raise RuntimeError("ENV TOKEN –Ω–µ –∑–∞–¥–∞–Ω. –£—Å—Ç–∞–Ω–æ–≤–∏ TOKEN –≤ Render ‚Üí Environment.")

# ====== –°–ø–∏—Å–æ–∫ —Ü–∏—Ç–∞—Ç ======
quotes = [
    "–ë—É–¥—å —Å–∞–º–æ–π –ª—É—á—à–µ–π –≤–µ—Ä—Å–∏–µ–π —Å–µ–±—è. ‚Äî –û–¥—Ä–∏ –•–µ–ø–±—ë—Ä–Ω",
    "–°–∏–ª—å–Ω–∞—è –∂–µ–Ω—â–∏–Ω–∞ —É–ª—ã–±–∞–µ—Ç—Å—è —Å–∫–≤–æ–∑—å —Å–ª—ë–∑—ã. ‚Äî –ú—ç—Ä–∏–ª–∏–Ω –ú–æ–Ω—Ä–æ",
    "–ù–∏–∫—Ç–æ –Ω–µ –º–æ–∂–µ—Ç –∑–∞—Å—Ç–∞–≤–∏—Ç—å —Ç–µ–±—è —á—É–≤—Å—Ç–≤–æ–≤–∞—Ç—å —Å–µ–±—è —Ö—É–∂–µ –±–µ–∑ —Ç–≤–æ–µ–≥–æ —Å–æ–≥–ª–∞—Å–∏—è. ‚Äî –≠–ª–µ–æ–Ω–æ—Ä –†—É–∑–≤–µ–ª—å—Ç",
    "–°–µ–∫—Ä–µ—Ç –ø—Ä–∏–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∂–µ–Ω—â–∏–Ω—ã ‚Äî –≤ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏. ‚Äî –°–æ—Ñ–∏—è –õ–æ—Ä–µ–Ω",
    "–õ—é–±–æ–≤—å ‚Äî —ç—Ç–æ –∫–æ–≥–¥–∞ —Å—á–∞—Å—Ç—å–µ –¥—Ä—É–≥–æ–≥–æ –≤–∞–∂–Ω–µ–µ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ. ‚Äî –î–∞–ª–∞–π-–ª–∞–º–∞ XIV",
    "–ù–µ –∏—â–∏ –ø—Ä–∏–Ω—Ü–∞, –±—É–¥—å –∫–æ—Ä–æ–ª–µ–≤–æ–π. ‚Äî –ö–æ–∫–æ –®–∞–Ω–µ–ª—å",
    "–¢—ã —Å–∏–ª—å–Ω–µ–µ, —á–µ–º –¥—É–º–∞–µ—à—å. ‚Äî –°–µ—Ä–µ–Ω–∞ –£–∏–ª—å—è–º—Å",
    "–ì–ª–∞–≤–Ω–æ–µ –≤ –∂–µ–Ω—â–∏–Ω–µ ‚Äî –µ—ë –≥–ª–∞–∑–∞, –æ–Ω–∏ –¥–≤–µ—Ä—å –≤ —Å–µ—Ä–¥—Ü–µ. ‚Äî –û–¥—Ä–∏ –•–µ–ø–±—ë—Ä–Ω",
    "–ú–∏—Ä –ª–æ–º–∞–µ—Ç –≤—Å–µ—Ö, –Ω–æ –ø–æ—Å–ª–µ –º–Ω–æ–≥–∏–µ —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è —Å–∏–ª—å–Ω–µ–µ. ‚Äî –≠—Ä–Ω–µ—Å—Ç –•–µ–º–∏–Ω–≥—É—ç–π",
    "–õ—é–±–∏—Ç—å —Å–µ–±—è ‚Äî —ç—Ç–æ –Ω–∞—á–∞–ª–æ —Ä–æ–º–∞–Ω–∞ –Ω–∞ –≤—Å—é –∂–∏–∑–Ω—å. ‚Äî –û—Å–∫–∞—Ä –£–∞–π–ª—å–¥",
    "–°—á–∞—Å—Ç—å–µ –∂–µ–Ω—â–∏–Ω—ã –≤ –µ—ë —Ä—É–∫–∞—Ö. ‚Äî –ú–∞–¥–æ–Ω–Ω–∞",
    "–ö—Ä–∞—Å–æ—Ç–∞ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –≤ —Ç–æ—Ç –º–æ–º–µ–Ω—Ç, –∫–æ–≥–¥–∞ —Ç—ã —Ä–µ—à–∞–µ—à—å –±—ã—Ç—å —Å–æ–±–æ–π. ‚Äî –ö–æ–∫–æ –®–∞–Ω–µ–ª—å",
    "–ù–∏–∫–æ–≥–¥–∞ –Ω–µ –ø–æ–∑–¥–Ω–æ –±—ã—Ç—å —Ç–µ–º, –∫–µ–º —Ç—ã –º–æ–≥ –±—ã —Å—Ç–∞—Ç—å. ‚Äî –î–∂–æ—Ä–¥–∂ –≠–ª–∏–æ—Ç",
    "–õ—é–±–æ–≤—å ‚Äî —ç—Ç–æ –≤—ã–±–æ—Ä –∫–∞–∂–¥—ã–π –¥–µ–Ω—å. ‚Äî –ë–∞—Ä–±–∞—Ä–∞ –î–µ –ê–Ω–¥–∂–µ–ª–∏—Å",
    "–ù–∏ –æ–¥–Ω–∞ –∂–µ–Ω—â–∏–Ω–∞ –Ω–µ –æ–±—è–∑–∞–Ω–∞ –±—ã—Ç—å –∏–¥–µ–∞–ª—å–Ω–æ–π, —á—Ç–æ–±—ã –±—ã—Ç—å –ª—é–±–∏–º–æ–π. ‚Äî –ú—ç—Ä–∏–ª–∏–Ω –ú–æ–Ω—Ä–æ",
    "–¢–≤–æ—è —ç–Ω–µ—Ä–≥–∏—è –ø—Ä–∏—Ç—è–≥–∏–≤–∞–µ—Ç —Ç–æ, —á—Ç–æ —Ç—ã –∏–∑–ª—É—á–∞–µ—à—å. ‚Äî –û–ø—Ä–∞ –£–∏–Ω—Ñ—Ä–∏",
    "–°–∞–º–æ–µ –≤–∞–∂–Ω–æ–µ –≤ –∂–∏–∑–Ω–∏ ‚Äî –Ω–∞—É—á–∏—Ç—å—Å—è –æ—Ç–¥–∞–≤–∞—Ç—å –ª—é–±–æ–≤—å –∏ –ø—Ä–∏–Ω–∏–º–∞—Ç—å –µ—ë. ‚Äî –ú–æ—Ä—Ä–∏ –®–≤–∞—Ä—Ü",
    "–ñ–µ–Ω—â–∏–Ω–∞ ‚Äî —ç—Ç–æ —Å–∏–ª–∞, –∑–∞–º–∞—Å–∫–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ø–æ–¥ –Ω–µ–∂–Ω–æ—Å—Ç—å. ‚Äî –ñ–∞–∫–ª–∏–Ω –ö–µ–Ω–Ω–µ–¥–∏",
    "–õ—é–±–∏ –∂–∏–∑–Ω—å, –∏ –∂–∏–∑–Ω—å –ø–æ–ª—é–±–∏—Ç —Ç–µ–±—è. ‚Äî –ê—Ä—Ç—É—Ä –†—É–±–∏–Ω—à—Ç–µ–π–Ω",
    "–°—á–∞—Å—Ç–ª–∏–≤–∞—è –∂–µ–Ω—â–∏–Ω–∞ —É–∫—Ä–∞—à–∞–µ—Ç –≤–µ—Å—å –º–∏—Ä. ‚Äî –°–æ—Ñ–∏—è –õ–æ—Ä–µ–Ω",
    "–ú—ã –ø—Ä–∏–Ω–∏–º–∞–µ–º –ª—é–±–æ–≤—å, –∫–æ—Ç–æ—Ä—É—é –¥—É–º–∞–µ–º, —á—Ç–æ –∑–∞—Å–ª—É–∂–∏–≤–∞–µ–º. ‚Äî –°—Ç–∏–≤–µ–Ω –ß–±–æ—Å–∫–∏",
    "–í–µ—Ä—å –≤ —á—É–¥–µ—Å–∞ ‚Äî –∏ –æ–Ω–∏ –ø—Ä–∏–¥—É—Ç. ‚Äî –õ—É–∏–∑–∞ –•–µ–π",
    "–õ—é–±–æ–≤—å ‚Äî —ç—Ç–æ –Ω–µ –Ω–∞—Ö–æ–¥–∏—Ç—å –∏–¥–µ–∞–ª—å–Ω–æ–≥–æ, –∞ –≤–∏–¥–µ—Ç—å –∏–¥–µ–∞–ª—å–Ω–æ–µ –≤ —á–µ–ª–æ–≤–µ–∫–µ. ‚Äî –°—ç–º –ö–∏–Ω",
    "–°–∏–ª—å–Ω–∞—è –∂–µ–Ω—â–∏–Ω–∞ –ø–æ–¥–Ω–∏–º–∞–µ—Ç –¥—Ä—É–≥–∏—Ö. ‚Äî –ú–∏—à–µ–ª—å –û–±–∞–º–∞",
    "–¢—ã –¥–æ—Å—Ç–æ–π–Ω–∞ –ª—É—á—à–µ–≥–æ. ‚Äî –î–∂–µ–Ω–Ω–∏—Ñ–µ—Ä –õ–æ–ø–µ—Å",
    "–í—Å—ë –≤–æ–∑–º–æ–∂–Ω–æ –¥–ª—è —Ç–æ–≥–æ, –∫—Ç–æ –≤–µ—Ä–∏—Ç. ‚Äî –ú–∞—Ä–∫ 9:23",
    "–ù–∞—Å—Ç–æ—è—â–∞—è –ª—é–±–æ–≤—å –Ω–µ —Ç—Ä–µ–±—É–µ—Ç –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤. ‚Äî –ê–Ω—Ç—É–∞–Ω –¥–µ –°–µ–Ω—Ç-–≠–∫–∑—é–ø–µ—Ä–∏",
    "–ñ–µ–Ω—â–∏–Ω–∞ ‚Äî —ç—Ç–æ –º—É–∑—ã–∫–∞, –∫–æ—Ç–æ—Ä—É—é –Ω–∞–¥–æ —É–º–µ—Ç—å —Å–ª—É—à–∞—Ç—å. ‚Äî –í–∏–∫—Ç–æ—Ä –ì—é–≥–æ",
    "–ù–µ –±–æ–π—Å—è –º–µ–Ω—è—Ç—å –∂–∏–∑–Ω—å. ‚Äî –≠–ª–∏–∑–∞–±–µ—Ç –ì–∏–ª–±–µ—Ä—Ç",
    "–í—Å—ë, —á—Ç–æ —Ç—ã –º–æ–∂–µ—à—å —Å–µ–±–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç—å, —Ä–µ–∞–ª—å–Ω–æ. ‚Äî –ü–∞–±–ª–æ –ü–∏–∫–∞—Å—Å–æ",
    "–õ—é–±–æ–≤—å ‚Äî —ç—Ç–æ –∏—Å–∫—É—Å—Å—Ç–≤–æ –Ω–∞—Ö–æ–¥–∏—Ç—å —Å–µ–±—è –≤ –¥—Ä—É–≥–æ–º. ‚Äî –§—Ä–∏–¥—Ä–∏—Ö –ù–∏—Ü—à–µ",
    "–£–ª—ã–±–∫–∞ ‚Äî –ª—É—á—à–∏–π –º–∞–∫–∏—è–∂ –¥–µ–≤—É—à–∫–∏. ‚Äî –ú—ç—Ä–∏–ª–∏–Ω –ú–æ–Ω—Ä–æ",
    "–ñ–µ–Ω—â–∏–Ω–∞ —Å–∏—è–µ—Ç, –∫–æ–≥–¥–∞ –ª—é–±–∏–º–∞. ‚Äî –õ–µ–≤ –¢–æ–ª—Å—Ç–æ–π",
    "–¢–æ–ª—å–∫–æ –ª—é–±–æ–≤—å –¥–µ–ª–∞–µ—Ç –Ω–∞—Å –ø–æ-–Ω–∞—Å—Ç–æ—è—â–µ–º—É –∂–∏–≤—ã–º–∏. ‚Äî –õ–µ–æ –ë—É—Å–∫–∞–ª—å—è",
    "–ù–µ —Å—Ä–∞–≤–Ω–∏–≤–∞–π —Å–µ–±—è —Å –¥—Ä—É–≥–∏–º–∏. ‚Äî –ë–µ–π–æ–Ω—Å–µ",
    "–°–∞–º–æ–µ –ø—Ä–µ–∫—Ä–∞—Å–Ω–æ–µ –≤ –∂–µ–Ω—â–∏–Ω–µ ‚Äî –µ—ë –¥—É—à–∞. ‚Äî –ü–ª–∞—Ç–æ–Ω",
    "–ï—Å–ª–∏ —Ö–æ—á–µ—à—å, —á—Ç–æ–±—ã —Ç–µ–±—è –ª—é–±–∏–ª–∏, –ª—é–±–∏ —Å–∞–º–∞. ‚Äî –°–µ–Ω–µ–∫–∞",
    "–ë—É–¥—å —Ç–æ–π, –∫–µ–º —Ç—ã –≥–æ—Ä–¥–∏—à—å—Å—è. ‚Äî –ú–µ–≥–∞–Ω –ú–∞—Ä–∫–ª",
    "–õ—é–±–æ–≤—å ‚Äî —ç—Ç–æ –∫–æ–≥–¥–∞ –Ω–µ —Ö–æ—á–µ—à—å –∑–∞—Å—ã–ø–∞—Ç—å, –ø–æ—Ç–æ–º—É —á—Ç–æ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç—å –ª—É—á—à–µ —Å–Ω–∞. ‚Äî –î–æ–∫—Ç–æ—Ä –°—å—é–∑",
    "–ö—Ç–æ –Ω–µ —Ä–∏—Å–∫—É–µ—Ç, —Ç–æ—Ç –Ω–µ –ª—é–±–∏—Ç. ‚Äî –≠—Ä–∏—Ö –ú–∞—Ä–∏—è –†–µ–º–∞—Ä–∫",
    "–°—á–∞—Å—Ç—å–µ –≤–Ω—É—Ç—Ä–∏ —Ç–µ–±—è. ‚Äî –õ—É–∏–∑–∞ –•–µ–π",
    "–ñ–µ–Ω—â–∏–Ω–∞ ‚Äî –∫–∞–∫ —á–∞–π–Ω—ã–π –ø–∞–∫–µ—Ç–∏–∫: –µ—ë —Å–∏–ª–∞ –≤–∏–¥–Ω–∞, –∫–æ–≥–¥–∞ –æ–Ω–∞ –≤ –≥–æ—Ä—è—á–µ–π –≤–æ–¥–µ. ‚Äî –≠–ª–µ–æ–Ω–æ—Ä –†—É–∑–≤–µ–ª—å—Ç",
    "–ë–µ–∑ –ª—é–±–≤–∏ –∂–∏–∑–Ω—å ‚Äî –ø—É—Å—Ç–∞—è —Å–∫–æ—Ä–ª—É–ø–∞. ‚Äî –•–∞–ª–∏–ª—å –î–∂–µ–±—Ä–∞–Ω",
    "–°–∏–ª—å–Ω–∞—è –∂–µ–Ω—â–∏–Ω–∞ —É–ª—ã–±–∞–µ—Ç—Å—è, –¥–∞–∂–µ –∫–æ–≥–¥–∞ —Å–µ—Ä–¥—Ü–µ –ø–ª–∞—á–µ—Ç. ‚Äî –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∞–≤—Ç–æ—Ä",
    "–¢—ã –∑–∞—Å–ª—É–∂–∏–≤–∞–µ—à—å —Ç–æ–≥–æ, –∫—Ç–æ –±—É–¥–µ—Ç –±–æ—è—Ç—å—Å—è –ø–æ—Ç–µ—Ä—è—Ç—å —Ç–µ–±—è. ‚Äî –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∞–≤—Ç–æ—Ä",
    "–í–µ—Ä—å –≤ —Å–µ–±—è, –∏ –≤–µ—Å—å –º–∏—Ä –ø–æ–≤–µ—Ä–∏—Ç –≤ —Ç–µ–±—è. ‚Äî –í–∏—Ä–¥–∂–∏–Ω–∏—è –í—É–ª—Ñ",
    "–ö—Ä–∞—Å–æ—Ç–∞ ‚Äî —ç—Ç–æ —Å–≤–µ—Ç –≤ —Å–µ—Ä–¥—Ü–µ. ‚Äî –•–∞–ª–∏–ª—å –î–∂–µ–±—Ä–∞–Ω",
    "–õ—é–±–æ–≤—å ‚Äî —ç—Ç–æ –∫–ª—é—á –∫ —Å—á–∞—Å—Ç—å—é. ‚Äî –ë—É–¥–¥–∞",
    "–ñ–µ–Ω—â–∏–Ω–∞ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –Ω–µ–ø–æ–±–µ–¥–∏–º–æ–π, –∫–æ–≥–¥–∞ –≤–µ—Ä–∏—Ç –≤ —Å–µ–±—è. ‚Äî –û–ø—Ä–∞ –£–∏–Ω—Ñ—Ä–∏",
    "–°—á–∞—Å—Ç–ª–∏–≤–∞—è –∂–µ–Ω—â–∏–Ω–∞ ‚Äî —ç—Ç–æ —Å–∏–ª–∞. ‚Äî –ú–∏—à–µ–ª—å –û–±–∞–º–∞"
]

# ====== –ö–Ω–æ–ø–∫–∏ ======
def start_keyboard():
    return ReplyKeyboardMarkup(
        [["üöÄ –°—Ç–∞—Ä—Ç", "üíå –¶–∏—Ç–∞—Ç–∞ –¥–Ω—è"]],
        resize_keyboard=True
    )

def quote_action_keyboard():
    return ReplyKeyboardMarkup(
        [["üì¢ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ –∫–∞–Ω–∞–ª", "üîÑ –î—Ä—É–≥–∞—è —Ü–∏—Ç–∞—Ç–∞"]],
        resize_keyboard=True
    )

# ====== –•–µ–Ω–¥–ª–µ—Ä—ã ======
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    quote = random.choice(quotes)
    context.user_data["current_quote"] = quote
    await update.message.reply_text(quote, reply_markup=quote_action_keyboard())

async def quote_of_the_day(update: Update, context: ContextTypes.DEFAULT_TYPE):
    quote = random.choice(quotes)
    context.user_data["current_quote"] = quote
    await update.message.reply_text(quote, reply_markup=quote_action_keyboard())

async def send_to_channel(update: Update, context: ContextTypes.DEFAULT_TYPE):
    quote = context.user_data.get("current_quote")
    if not quote:
        await update.message.reply_text("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏ üöÄ –°—Ç–∞—Ä—Ç –∏–ª–∏ üíå –¶–∏—Ç–∞—Ç–∞ –¥–Ω—è!")
        return
    await context.bot.send_message(chat_id=CHANNEL_ID, text=quote)
    await update.message.reply_text("‚úÖ –¶–∏—Ç–∞—Ç–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –≤ –∫–∞–Ω–∞–ª!")

async def change_quote(update: Update, context: ContextTypes.DEFAULT_TYPE):
    quote = random.choice(quotes)
    context.user_data["current_quote"] = quote
    await update.message.reply_text(quote, reply_markup=quote_action_keyboard())

async def ignore_text(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text("–ò—Å–ø–æ–ª—å–∑—É–π –∫–Ω–æ–ø–∫–∏ –Ω–∏–∂–µ ‚¨áÔ∏è", reply_markup=start_keyboard())

# ====== –ó–∞–ø—É—Å–∫ ======
def build_app():
    app = ApplicationBuilder().token(TOKEN).build()

    app.add_handler(CommandHandler("start", start))
    app.add_handler(MessageHandler(filters.Regex("^üöÄ –°—Ç–∞—Ä—Ç$"), start))
    app.add_handler(MessageHandler(filters.Regex("^üíå –¶–∏—Ç–∞—Ç–∞ –¥–Ω—è$"), quote_of_the_day))
    app.add_handler(MessageHandler(filters.Regex("^üì¢ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ –∫–∞–Ω–∞–ª$"), send_to_channel))
    app.add_handler(MessageHandler(filters.Regex("^üîÑ –î—Ä—É–≥–∞—è —Ü–∏—Ç–∞—Ç–∞$"), change_quote))
    app.add_handler(MessageHandler(filters.ALL, ignore_text))

    return app

if __name__ == "__main__":
    app = build_app()

    print(f"=== DEBUG: ENV VARS ===")
    print(f"TOKEN: {TOKEN}")
    print(f"WEBHOOK_BASE: {WEBHOOK_BASE}")
    print(f"CHANNEL_ID: {CHANNEL_ID}")
    print(f"MODE: {MODE}")
    print(f"PORT: {PORT}")
    print("=======================")

    if MODE == "webhook":
        print("[LOG] –ó–∞–ø—É—Å–∫ –≤ —Ä–µ–∂–∏–º–µ WEBHOOK")
        app.run_webhook(
            listen="0.0.0.0",
            port=PORT,
            url_path=TOKEN,
            webhook_url=f"{WEBHOOK_BASE}/{TOKEN}"
        )
    else:
        print("[LOG] –ó–∞–ø—É—Å–∫ –≤ —Ä–µ–∂–∏–º–µ POLLING")
        app.run_polling()