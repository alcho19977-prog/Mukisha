import os
import random
import logging
from telegram import Update, ReplyKeyboardMarkup
from telegram.ext import ApplicationBuilder, CommandHandler, ContextTypes, MessageHandler, filters
from apscheduler.schedulers.asyncio import AsyncIOScheduler
from datetime import time

# ===== –õ–û–ì–ò =====
logging.basicConfig(
    format="%(asctime)s - %(name)s - %(levelname)s - %(message)s",
    level=logging.INFO
)

# ===== –¶–ò–¢–ê–¢–´ =====
QUOTES = [
    "–ë—É–¥—å —Å–∞–º–æ–π –ª—É—á—à–µ–π –≤–µ—Ä—Å–∏–µ–π —Å–µ–±—è. ‚Äî –û–¥—Ä–∏ –•–µ–ø–±—ë—Ä–Ω",
    "–°–∏–ª—å–Ω–∞—è –∂–µ–Ω—â–∏–Ω–∞ —É–ª—ã–±–∞–µ—Ç—Å—è —Å–∫–≤–æ–∑—å —Å–ª—ë–∑—ã. ‚Äî –ú—ç—Ä–∏–ª–∏–Ω –ú–æ–Ω—Ä–æ",
    "–ù–∏–∫—Ç–æ –Ω–µ –º–æ–∂–µ—Ç –∑–∞—Å—Ç–∞–≤–∏—Ç—å —Ç–µ–±—è —á—É–≤—Å—Ç–≤–æ–≤–∞—Ç—å —Å–µ–±—è —Ö—É–∂–µ –±–µ–∑ —Ç–≤–æ–µ–≥–æ —Å–æ–≥–ª–∞—Å–∏—è. ‚Äî –≠–ª–µ–æ–Ω–æ—Ä –†—É–∑–≤–µ–ª—å—Ç",
    "–°–µ–∫—Ä–µ—Ç –ø—Ä–∏–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∂–µ–Ω—â–∏–Ω—ã ‚Äî –≤ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏. ‚Äî –°–æ—Ñ–∏—è –õ–æ—Ä–µ–Ω",
    "–õ—é–±–æ–≤—å ‚Äî —ç—Ç–æ –∫–æ–≥–¥–∞ —Å—á–∞—Å—Ç—å–µ –¥—Ä—É–≥–æ–≥–æ –≤–∞–∂–Ω–µ–µ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ. ‚Äî –î–∞–ª–∞–π-–ª–∞–º–∞ XIV",
    "–ù–µ –∏—â–∏ –ø—Ä–∏–Ω—Ü–∞, –±—É–¥—å –∫–æ—Ä–æ–ª–µ–≤–æ–π. ‚Äî –ö–æ–∫–æ –®–∞–Ω–µ–ª—å",
    "–¢—ã —Å–∏–ª—å–Ω–µ–µ, —á–µ–º –¥—É–º–∞–µ—à—å. ‚Äî –°–µ—Ä–µ–Ω–∞ –£–∏–ª—å—è–º—Å",
    "–ì–ª–∞–≤–Ω–æ–µ –≤ –∂–µ–Ω—â–∏–Ω–µ ‚Äî –µ—ë –≥–ª–∞–∑–∞, –æ–Ω–∏ –¥–≤–µ—Ä—å –≤ —Å–µ—Ä–¥—Ü–µ. ‚Äî –û–¥—Ä–∏ –•–µ–ø–±—ë—Ä–Ω",
    "–ú–∏—Ä –ª–æ–º–∞–µ—Ç –≤—Å–µ—Ö, –Ω–æ –ø–æ—Å–ª–µ –º–Ω–æ–≥–∏–µ —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è —Å–∏–ª—å–Ω–µ–µ. ‚Äî –≠—Ä–Ω–µ—Å—Ç –•–µ–º–∏–Ω–≥—É—ç–π",
    "–õ—é–±–∏—Ç—å —Å–µ–±—è ‚Äî —ç—Ç–æ –Ω–∞—á–∞–ª–æ —Ä–æ–º–∞–Ω–∞ –Ω–∞ –≤—Å—é –∂–∏–∑–Ω—å. ‚Äî –û—Å–∫–∞—Ä –£–∞–π–ª—å–¥",
    "–°—á–∞—Å—Ç—å–µ –∂–µ–Ω—â–∏–Ω—ã –≤ –µ—ë —Ä—É–∫–∞—Ö. ‚Äî –ú–∞–¥–æ–Ω–Ω–∞",
    "–ö—Ä–∞—Å–æ—Ç–∞ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –≤ —Ç–æ—Ç –º–æ–º–µ–Ω—Ç, –∫–æ–≥–¥–∞ —Ç—ã —Ä–µ—à–∞–µ—à—å –±—ã—Ç—å —Å–æ–±–æ–π. ‚Äî –ö–æ–∫–æ –®–∞–Ω–µ–ª—å",
    "–ù–∏–∫–æ–≥–¥–∞ –Ω–µ –ø–æ–∑–¥–Ω–æ –±—ã—Ç—å —Ç–µ–º, –∫–µ–º —Ç—ã –º–æ–≥ –±—ã —Å—Ç–∞—Ç—å. ‚Äî –î–∂–æ—Ä–¥–∂ –≠–ª–∏–æ—Ç",
    "–õ—é–±–æ–≤—å ‚Äî —ç—Ç–æ –≤—ã–±–æ—Ä –∫–∞–∂–¥—ã–π –¥–µ–Ω—å. ‚Äî –ë–∞—Ä–±–∞—Ä–∞ –î–µ –ê–Ω–¥–∂–µ–ª–∏—Å",
    "–ù–∏ –æ–¥–Ω–∞ –∂–µ–Ω—â–∏–Ω–∞ –Ω–µ –æ–±—è–∑–∞–Ω–∞ –±—ã—Ç—å –∏–¥–µ–∞–ª—å–Ω–æ–π, —á—Ç–æ–±—ã –±—ã—Ç—å –ª—é–±–∏–º–æ–π. ‚Äî –ú—ç—Ä–∏–ª–∏–Ω –ú–æ–Ω—Ä–æ",
    "–¢–≤–æ—è —ç–Ω–µ—Ä–≥–∏—è –ø—Ä–∏—Ç—è–≥–∏–≤–∞–µ—Ç —Ç–æ, —á—Ç–æ —Ç—ã –∏–∑–ª—É—á–∞–µ—à—å. ‚Äî –û–ø—Ä–∞ –£–∏–Ω—Ñ—Ä–∏",
    "–°–∞–º–æ–µ –≤–∞–∂–Ω–æ–µ –≤ –∂–∏–∑–Ω–∏ ‚Äî –Ω–∞—É—á–∏—Ç—å—Å—è –æ—Ç–¥–∞–≤–∞—Ç—å –ª—é–±–æ–≤—å –∏ –ø—Ä–∏–Ω–∏–º–∞—Ç—å –µ—ë. ‚Äî –ú–æ—Ä—Ä–∏ –®–≤–∞—Ä—Ü",
    "–ñ–µ–Ω—â–∏–Ω–∞ ‚Äî —ç—Ç–æ —Å–∏–ª–∞, –∑–∞–º–∞—Å–∫–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ø–æ–¥ –Ω–µ–∂–Ω–æ—Å—Ç—å. ‚Äî –ñ–∞–∫–ª–∏–Ω –ö–µ–Ω–Ω–µ–¥–∏",
    "–õ—é–±–∏ –∂–∏–∑–Ω—å, –∏ –∂–∏–∑–Ω—å –ø–æ–ª—é–±–∏—Ç —Ç–µ–±—è. ‚Äî –ê—Ä—Ç—É—Ä –†—É–±–∏–Ω—à—Ç–µ–π–Ω",
    "–°—á–∞—Å—Ç–ª–∏–≤–∞—è –∂–µ–Ω—â–∏–Ω–∞ —É–∫—Ä–∞—à–∞–µ—Ç –≤–µ—Å—å –º–∏—Ä. ‚Äî –°–æ—Ñ–∏—è –õ–æ—Ä–µ–Ω",
    "–ú—ã –ø—Ä–∏–Ω–∏–º–∞–µ–º –ª—é–±–æ–≤—å, –∫–æ—Ç–æ—Ä—É—é –¥—É–º–∞–µ–º, —á—Ç–æ –∑–∞—Å–ª—É–∂–∏–≤–∞–µ–º. ‚Äî –°—Ç–∏–≤–µ–Ω –ß–±–æ—Å–∫–∏",
    "–í–µ—Ä—å –≤ —á—É–¥–µ—Å–∞ ‚Äî –∏ –æ–Ω–∏ –ø—Ä–∏–¥—É—Ç. ‚Äî –õ—É–∏–∑–∞ –•–µ–π",
    "–õ—é–±–æ–≤—å ‚Äî —ç—Ç–æ –Ω–µ –Ω–∞—Ö–æ–¥–∏—Ç—å –∏–¥–µ–∞–ª—å–Ω–æ–≥–æ, –∞ –≤–∏–¥–µ—Ç—å –∏–¥–µ–∞–ª—å–Ω–æ–µ –≤ —á–µ–ª–æ–≤–µ–∫–µ. ‚Äî –°—ç–º –ö–∏–Ω",
    "–°–∏–ª—å–Ω–∞—è –∂–µ–Ω—â–∏–Ω–∞ –ø–æ–¥–Ω–∏–º–∞–µ—Ç –¥—Ä—É–≥–∏—Ö. ‚Äî –ú–∏—à–µ–ª—å –û–±–∞–º–∞",
    "–¢—ã –¥–æ—Å—Ç–æ–π–Ω–∞ –ª—É—á—à–µ–≥–æ. ‚Äî –î–∂–µ–Ω–Ω–∏—Ñ–µ—Ä –õ–æ–ø–µ—Å",
    "–í—Å—ë –≤–æ–∑–º–æ–∂–Ω–æ –¥–ª—è —Ç–æ–≥–æ, –∫—Ç–æ –≤–µ—Ä–∏—Ç. ‚Äî –ú–∞—Ä–∫ 9:23",
    "–ù–∞—Å—Ç–æ—è—â–∞—è –ª—é–±–æ–≤—å –Ω–µ —Ç—Ä–µ–±—É–µ—Ç –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤. ‚Äî –ê–Ω—Ç—É–∞–Ω –¥–µ –°–µ–Ω—Ç-–≠–∫–∑—é–ø–µ—Ä–∏",
    "–ñ–µ–Ω—â–∏–Ω–∞ ‚Äî —ç—Ç–æ –º—É–∑—ã–∫–∞, –∫–æ—Ç–æ—Ä—É—é –Ω–∞–¥–æ —É–º–µ—Ç—å —Å–ª—É—à–∞—Ç—å. ‚Äî –í–∏–∫—Ç–æ—Ä –ì—é–≥–æ",
    "–ù–µ –±–æ–π—Å—è –º–µ–Ω—è—Ç—å –∂–∏–∑–Ω—å. ‚Äî –≠–ª–∏–∑–∞–±–µ—Ç –ì–∏–ª–±–µ—Ä—Ç",
    "–í—Å—ë, —á—Ç–æ —Ç—ã –º–æ–∂–µ—à—å —Å–µ–±–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç—å, —Ä–µ–∞–ª—å–Ω–æ. ‚Äî –ü–∞–±–ª–æ –ü–∏–∫–∞—Å—Å–æ",
    "–õ—é–±–æ–≤—å ‚Äî —ç—Ç–æ –∏—Å–∫—É—Å—Å—Ç–≤–æ –Ω–∞—Ö–æ–¥–∏—Ç—å —Å–µ–±—è –≤ –¥—Ä—É–≥–æ–º. ‚Äî –§—Ä–∏–¥—Ä–∏—Ö –ù–∏—Ü—à–µ",
    "–£–ª—ã–±–∫–∞ ‚Äî –ª—É—á—à–∏–π –º–∞–∫–∏—è–∂ –¥–µ–≤—É—à–∫–∏. ‚Äî –ú—ç—Ä–∏–ª–∏–Ω –ú–æ–Ω—Ä–æ",
    "–ñ–µ–Ω—â–∏–Ω–∞ —Å–∏—è–µ—Ç, –∫–æ–≥–¥–∞ –ª—é–±–∏–º–∞. ‚Äî –õ–µ–≤ –¢–æ–ª—Å—Ç–æ–π",
    "–¢–æ–ª—å–∫–æ –ª—é–±–æ–≤—å –¥–µ–ª–∞–µ—Ç –Ω–∞—Å –ø–æ-–Ω–∞—Å—Ç–æ—è—â–µ–º—É –∂–∏–≤—ã–º–∏. ‚Äî –õ–µ–æ –ë—É—Å–∫–∞–ª—å—è",
    "–ù–µ —Å—Ä–∞–≤–Ω–∏–≤–∞–π —Å–µ–±—è —Å –¥—Ä—É–≥–∏–º–∏. ‚Äî –ë–µ–π–æ–Ω—Å–µ",
    "–°–∞–º–æ–µ –ø—Ä–µ–∫—Ä–∞—Å–Ω–æ–µ –≤ –∂–µ–Ω—â–∏–Ω–µ ‚Äî –µ—ë –¥—É—à–∞. ‚Äî –ü–ª–∞—Ç–æ–Ω",
    "–ï—Å–ª–∏ —Ö–æ—á–µ—à—å, —á—Ç–æ–±—ã —Ç–µ–±—è –ª—é–±–∏–ª–∏, –ª—é–±–∏ —Å–∞–º–∞. ‚Äî –°–µ–Ω–µ–∫–∞",
    "–ë—É–¥—å —Ç–æ–π, –∫–µ–º —Ç—ã –≥–æ—Ä–¥–∏—à—å—Å—è. ‚Äî –ú–µ–≥–∞–Ω –ú–∞—Ä–∫–ª",
    "–õ—é–±–æ–≤—å ‚Äî —ç—Ç–æ –∫–æ–≥–¥–∞ –Ω–µ —Ö–æ—á–µ—à—å –∑–∞—Å—ã–ø–∞—Ç—å, –ø–æ—Ç–æ–º—É —á—Ç–æ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç—å –ª—É—á—à–µ —Å–Ω–∞. ‚Äî –î–æ–∫—Ç–æ—Ä –°—å—é–∑",
    "–ö—Ç–æ –Ω–µ —Ä–∏—Å–∫—É–µ—Ç, —Ç–æ—Ç –Ω–µ –ª—é–±–∏—Ç. ‚Äî –≠—Ä–∏—Ö –ú–∞—Ä–∏—è –†–µ–º–∞—Ä–∫",
    "–°—á–∞—Å—Ç—å–µ –≤–Ω—É—Ç—Ä–∏ —Ç–µ–±—è. ‚Äî –õ—É–∏–∑–∞ –•–µ–π",
    "–ñ–µ–Ω—â–∏–Ω–∞ ‚Äî –∫–∞–∫ —á–∞–π–Ω—ã–π –ø–∞–∫–µ—Ç–∏–∫: –µ—ë —Å–∏–ª–∞ –≤–∏–¥–Ω–∞, –∫–æ–≥–¥–∞ –æ–Ω–∞ –≤ –≥–æ—Ä—è—á–µ–π –≤–æ–¥–µ. ‚Äî –≠–ª–µ–æ–Ω–æ—Ä –†—É–∑–≤–µ–ª—å—Ç",
    "–ë–µ–∑ –ª—é–±–≤–∏ –∂–∏–∑–Ω—å ‚Äî –ø—É—Å—Ç–∞—è —Å–∫–æ—Ä–ª—É–ø–∞. ‚Äî –•–∞–ª–∏–ª—å –î–∂–µ–±—Ä–∞–Ω",
    "–í–µ—Ä—å –≤ —Å–µ–±—è, –∏ –≤–µ—Å—å –º–∏—Ä –ø–æ–≤–µ—Ä–∏—Ç –≤ —Ç–µ–±—è. ‚Äî –í–∏—Ä–¥–∂–∏–Ω–∏—è –í—É–ª—Ñ",
    "–ö—Ä–∞—Å–æ—Ç–∞ ‚Äî —ç—Ç–æ —Å–≤–µ—Ç –≤ —Å–µ—Ä–¥—Ü–µ. ‚Äî –•–∞–ª–∏–ª—å –î–∂–µ–±—Ä–∞–Ω",
    "–õ—é–±–æ–≤—å ‚Äî —ç—Ç–æ –∫–ª—é—á –∫ —Å—á–∞—Å—Ç—å—é. ‚Äî –ë—É–¥–¥–∞",
    "–ñ–µ–Ω—â–∏–Ω–∞ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –Ω–µ–ø–æ–±–µ–¥–∏–º–æ–π, –∫–æ–≥–¥–∞ –≤–µ—Ä–∏—Ç –≤ —Å–µ–±—è. ‚Äî –û–ø—Ä–∞ –£–∏–Ω—Ñ—Ä–∏",
    "–°—á–∞—Å—Ç–ª–∏–≤–∞—è –∂–µ–Ω—â–∏–Ω–∞ ‚Äî —ç—Ç–æ —Å–∏–ª–∞. ‚Äî –ú–∏—à–µ–ª—å –û–±–∞–º–∞"
]

# ===== –ü–ê–†–ê–ú–ï–¢–†–´ =====
TOKEN = os.getenv("TOKEN")
CHANNEL_ID = os.getenv("CHANNEL_ID")
MODE = os.getenv("MODE", "webhook")
WEBHOOK_BASE = os.getenv("WEBHOOK_BASE")
PORT = int(os.getenv("PORT", 10000))

if not TOKEN:
    raise RuntimeError("ENV TOKEN –Ω–µ –∑–∞–¥–∞–Ω. –£—Å—Ç–∞–Ω–æ–≤–∏ TOKEN –≤ Render ‚Üí Environment.")
if not CHANNEL_ID:
    raise RuntimeError("ENV CHANNEL_ID –Ω–µ –∑–∞–¥–∞–Ω.")

# ===== –õ–û–ì–ò –ü–ï–†–ï–ú–ï–ù–ù–´–• =====
print(f"PORT: {PORT}")
print(f"MODE: {MODE}")
print(f"CHANNEL_ID: {CHANNEL_ID}")
print(f"WEBHOOK_BASE: {WEBHOOK_BASE}")
print(f"TOKEN: {TOKEN}")

# ===== –§–£–ù–ö–¶–ò–ò =====
def get_random_quote():
    return random.choice(QUOTES)

async def send_daily_quote(context: ContextTypes.DEFAULT_TYPE):
    quote = get_random_quote()
    await context.bot.send_message(
        chat_id=CHANNEL_ID,
        text=f"üíå _{quote}_",
        parse_mode="Markdown"
    )

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    quote = get_random_quote()
    buttons = [["üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ –∫–∞–Ω–∞–ª", "üîÑ –î—Ä—É–≥–∞—è —Ü–∏—Ç–∞—Ç–∞"]]
    await update.message.reply_text(
        f"üíå _{quote}_",
        parse_mode="Markdown",
        reply_markup=ReplyKeyboardMarkup(buttons, resize_keyboard=True)
    )

async def handle_buttons(update: Update, context: ContextTypes.DEFAULT_TYPE):
    text = update.message.text
    if text == "üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ –∫–∞–Ω–∞–ª":
        quote = update.message.reply_to_message.text if update.message.reply_to_message else get_random_quote()
        await context.bot.send_message(
            chat_id=CHANNEL_ID,
            text=f"üíå {quote}",
            parse_mode="Markdown"
        )
        await update.message.reply_text("‚úÖ –¶–∏—Ç–∞—Ç–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –≤ –∫–∞–Ω–∞–ª.")
    elif text == "üîÑ –î—Ä—É–≥–∞—è —Ü–∏—Ç–∞—Ç–∞":
        await start(update, context)

# ===== –°–ë–û–†–ö–ê =====
app = ApplicationBuilder().token(TOKEN).build()

# –ê–≤—Ç–æ–ø–æ—Å—Ç–∏–Ω–≥ –≤ 10:00
scheduler = AsyncIOScheduler(timezone="Asia/Tashkent")
scheduler.add_job(send_daily_quote, trigger="cron", hour=10, minute=0, args=[app.bot])
scheduler.start()

app.add_handler(CommandHandler("start", start))
app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_buttons))

# ===== –ó–ê–ü–£–°–ö =====
if MODE == "webhook":
    app.run_webhook(
        listen="0.0.0.0",
        port=PORT,
        url_path=TOKEN,
        webhook_url=f"{WEBHOOK_BASE}/{TOKEN}"
    )
else:
    app.run_polling()