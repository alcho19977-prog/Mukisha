import os
import random
import logging
from telegram import Update, ReplyKeyboardMarkup
from telegram.ext import ApplicationBuilder, CommandHandler, ContextTypes, MessageHandler, filters
from apscheduler.schedulers.asyncio import AsyncIOScheduler
from datetime import time

# === ะะฐัััะพะนะบะธ ะปะพะณะพะฒ ===
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)

# === ะะฐะณััะทะบะฐ ะฟะตัะตะผะตะฝะฝัั ะพะบััะถะตะฝะธั ===
TOKEN = os.getenv("TOKEN")
WEBHOOK_BASE = os.getenv("WEBHOOK_BASE")
CHANNEL_ID = os.getenv("CHANNEL_ID")
MODE = os.getenv("MODE", "webhook")
PORT = int(os.getenv("PORT", 10000))

if not TOKEN:
    raise RuntimeError("ENV TOKEN ะฝะต ะทะฐะดะฐะฝ. ะฃััะฐะฝะพะฒะธ TOKEN=ัะฒะพะน_ัะพะบะตะฝ_ะฑะพัะฐ ะฒ Render โ Environment.")

# === ะกะฟะธัะพะบ ัะธัะฐั ===
QUOTES = [
    "ยซะัะดั ัะฐะผะพะน ะปัััะตะน ะฒะตััะธะตะน ัะตะฑั.ยป โ ะะดัะธ ะฅะตะฟะฑััะฝ",
    "ยซะกะธะปัะฝะฐั ะถะตะฝัะธะฝะฐ ัะปัะฑะฐะตััั ัะบะฒะพะทั ัะปัะทั.ยป โ ะััะธะปะธะฝ ะะพะฝัะพ",
    "ยซะะธะบัะพ ะฝะต ะผะพะถะตั ะทะฐััะฐะฒะธัั ัะตะฑั ััะฒััะฒะพะฒะฐัั ัะตะฑั ััะถะต ะฑะตะท ัะฒะพะตะณะพ ัะพะณะปะฐัะธั.ยป โ ะญะปะตะพะฝะพั ะัะทะฒะตะปัั",
    "ยซะกะตะบัะตั ะฟัะธะฒะปะตะบะฐัะตะปัะฝะพััะธ ะถะตะฝัะธะฝั โ ะฒ ัะฒะตัะตะฝะฝะพััะธ.ยป โ ะกะพัะธั ะะพัะตะฝ",
    "ยซะัะฑะพะฒั โ ััะพ ะบะพะณะดะฐ ััะฐัััะต ะดััะณะพะณะพ ะฒะฐะถะฝะตะต ัะพะฑััะฒะตะฝะฝะพะณะพ.ยป โ ะะฐะปะฐะน-ะปะฐะผะฐ XIV",
    "ยซะะต ะธัะธ ะฟัะธะฝัะฐ, ะฑัะดั ะบะพัะพะปะตะฒะพะน.ยป โ ะะพะบะพ ะจะฐะฝะตะปั",
    "ยซะขั ัะธะปัะฝะตะต, ัะตะผ ะดัะผะฐะตัั.ยป โ ะกะตัะตะฝะฐ ะฃะธะปััะผั",
    "ยซะะปะฐะฒะฝะพะต ะฒ ะถะตะฝัะธะฝะต โ ะตั ะณะปะฐะทะฐ, ะพะฝะธ ะดะฒะตัั ะฒ ัะตัะดัะต.ยป โ ะะดัะธ ะฅะตะฟะฑััะฝ",
    "ยซะะธั ะปะพะผะฐะตั ะฒัะตั, ะฝะพ ะฟะพัะปะต ะผะฝะพะณะธะต ััะฐะฝะพะฒัััั ัะธะปัะฝะตะต.ยป โ ะญัะฝะตัั ะฅะตะผะธะฝะณััะน",
    "ยซะัะฑะธัั ัะตะฑั โ ััะพ ะฝะฐัะฐะปะพ ัะพะผะฐะฝะฐ ะฝะฐ ะฒัั ะถะธะทะฝั.ยป โ ะัะบะฐั ะฃะฐะนะปัะด",
    "ยซะกัะฐัััะต ะถะตะฝัะธะฝั ะฒ ะตั ััะบะฐั.ยป โ ะะฐะดะพะฝะฝะฐ",
    "ยซะัะฐัะพัะฐ ะฝะฐัะธะฝะฐะตััั ะฒ ัะพั ะผะพะผะตะฝั, ะบะพะณะดะฐ ัั ัะตัะฐะตัั ะฑััั ัะพะฑะพะน.ยป โ ะะพะบะพ ะจะฐะฝะตะปั",
    "ยซะะธะบะพะณะดะฐ ะฝะต ะฟะพะทะดะฝะพ ะฑััั ัะตะผ, ะบะตะผ ัั ะผะพะณ ะฑั ััะฐัั.ยป โ ะะถะพัะดะถ ะญะปะธะพั",
    "ยซะัะฑะพะฒั โ ััะพ ะฒัะฑะพั ะบะฐะถะดัะน ะดะตะฝั.ยป โ ะะฐัะฑะฐัะฐ ะะต ะะฝะดะถะตะปะธั",
    "ยซะะธ ะพะดะฝะฐ ะถะตะฝัะธะฝะฐ ะฝะต ะพะฑัะทะฐะฝะฐ ะฑััั ะธะดะตะฐะปัะฝะพะน, ััะพะฑั ะฑััั ะปัะฑะธะผะพะน.ยป โ ะััะธะปะธะฝ ะะพะฝัะพ",
    "ยซะขะฒะพั ัะฝะตัะณะธั ะฟัะธััะณะธะฒะฐะตั ัะพ, ััะพ ัั ะธะทะปััะฐะตัั.ยป โ ะะฟัะฐ ะฃะธะฝััะธ",
    "ยซะกะฐะผะพะต ะฒะฐะถะฝะพะต ะฒ ะถะธะทะฝะธ โ ะฝะฐััะธัััั ะพัะดะฐะฒะฐัั ะปัะฑะพะฒั ะธ ะฟัะธะฝะธะผะฐัั ะตั.ยป โ ะะพััะธ ะจะฒะฐัั",
    "ยซะะตะฝัะธะฝะฐ โ ััะพ ัะธะปะฐ, ะทะฐะผะฐัะบะธัะพะฒะฐะฝะฝะฐั ะฟะพะด ะฝะตะถะฝะพััั.ยป โ ะะฐะบะปะธะฝ ะะตะฝะฝะตะดะธ",
    "ยซะัะฑะธ ะถะธะทะฝั, ะธ ะถะธะทะฝั ะฟะพะปัะฑะธั ัะตะฑั.ยป โ ะัััั ะัะฑะธะฝััะตะนะฝ",
    "ยซะกัะฐััะปะธะฒะฐั ะถะตะฝัะธะฝะฐ ัะบัะฐัะฐะตั ะฒะตัั ะผะธั.ยป โ ะกะพัะธั ะะพัะตะฝ",
    "ยซะั ะฟัะธะฝะธะผะฐะตะผ ะปัะฑะพะฒั, ะบะพัะพััั ะดัะผะฐะตะผ, ััะพ ะทะฐัะปัะถะธะฒะฐะตะผ.ยป โ ะกัะธะฒะตะฝ ะงะฑะพัะบะธ",
    "ยซะะตัั ะฒ ััะดะตัะฐ โ ะธ ะพะฝะธ ะฟัะธะดัั.ยป โ ะัะธะทะฐ ะฅะตะน",
    "ยซะัะฑะพะฒั โ ััะพ ะฝะต ะฝะฐัะพะดะธัั ะธะดะตะฐะปัะฝะพะณะพ, ะฐ ะฒะธะดะตัั ะธะดะตะฐะปัะฝะพะต ะฒ ัะตะปะพะฒะตะบะต.ยป โ ะกัะผ ะะธะฝ",
    "ยซะกะธะปัะฝะฐั ะถะตะฝัะธะฝะฐ ะฟะพะดะฝะธะผะฐะตั ะดััะณะธั.ยป โ ะะธัะตะปั ะะฑะฐะผะฐ",
    "ยซะขั ะดะพััะพะนะฝะฐ ะปัััะตะณะพ.ยป โ ะะถะตะฝะฝะธัะตั ะะพะฟะตั",
    "ยซะัั ะฒะพะทะผะพะถะฝะพ ะดะปั ัะพะณะพ, ะบัะพ ะฒะตัะธั.ยป โ ะะฐัะบ 9:23",
    "ยซะะฐััะพััะฐั ะปัะฑะพะฒั ะฝะต ััะตะฑัะตั ะดะพะบะฐะทะฐัะตะปัััะฒ.ยป โ ะะฝััะฐะฝ ะดะต ะกะตะฝั-ะญะบะทัะฟะตัะธ",
    "ยซะะตะฝัะธะฝะฐ โ ััะพ ะผัะทัะบะฐ, ะบะพัะพััั ะฝะฐะดะพ ัะผะตัั ัะปััะฐัั.ยป โ ะะธะบัะพั ะัะณะพ",
    "ยซะะต ะฑะพะนัั ะผะตะฝััั ะถะธะทะฝั.ยป โ ะญะปะธะทะฐะฑะตั ะะธะปะฑะตัั",
    "ยซะัั, ััะพ ัั ะผะพะถะตัั ัะตะฑะต ะฟัะตะดััะฐะฒะธัั, ัะตะฐะปัะฝะพ.ยป โ ะะฐะฑะปะพ ะะธะบะฐััะพ",
    "ยซะัะฑะพะฒั โ ััะพ ะธัะบััััะฒะพ ะฝะฐัะพะดะธัั ัะตะฑั ะฒ ะดััะณะพะผ.ยป โ ะคัะธะดัะธั ะะธััะต",
    "ยซะฃะปัะฑะบะฐ โ ะปัััะธะน ะผะฐะบะธัะถ ะดะตะฒััะบะธ.ยป โ ะััะธะปะธะฝ ะะพะฝัะพ",
    "ยซะะตะฝัะธะฝะฐ ัะธัะตั, ะบะพะณะดะฐ ะปัะฑะธะผะฐ.ยป โ ะะตะฒ ะขะพะปััะพะน",
    "ยซะขะพะปัะบะพ ะปัะฑะพะฒั ะดะตะปะฐะตั ะฝะฐั ะฟะพ-ะฝะฐััะพััะตะผั ะถะธะฒัะผะธ.ยป โ ะะตะพ ะััะบะฐะปัั",
    "ยซะะต ััะฐะฒะฝะธะฒะฐะน ัะตะฑั ั ะดััะณะธะผะธ.ยป โ ะะตะนะพะฝัะต",
    "ยซะกะฐะผะพะต ะฟัะตะบัะฐัะฝะพะต ะฒ ะถะตะฝัะธะฝะต โ ะตั ะดััะฐ.ยป โ ะะปะฐัะพะฝ",
    "ยซะัะปะธ ัะพัะตัั, ััะพะฑั ัะตะฑั ะปัะฑะธะปะธ, ะปัะฑะธ ัะฐะผะฐ.ยป โ ะกะตะฝะตะบะฐ",
    "ยซะัะดั ัะพะน, ะบะตะผ ัั ะณะพัะดะธัััั.ยป โ ะะตะณะฐะฝ ะะฐัะบะป",
    "ยซะัะฑะพะฒั โ ััะพ ะบะพะณะดะฐ ะฝะต ัะพัะตัั ะทะฐััะฟะฐัั, ะฟะพัะพะผั ััะพ ัะตะฐะปัะฝะพััั ะปัััะต ัะฝะฐ.ยป โ ะะพะบัะพั ะกััะท",
    "ยซะัะพ ะฝะต ัะธัะบัะตั, ัะพั ะฝะต ะปัะฑะธั.ยป โ ะญัะธั ะะฐัะธั ะะตะผะฐัะบ",
    "ยซะกัะฐัััะต ะฒะฝัััะธ ัะตะฑั.ยป โ ะัะธะทะฐ ะฅะตะน",
    "ยซะะตะฝัะธะฝะฐ โ ะบะฐะบ ัะฐะนะฝัะน ะฟะฐะบะตัะธะบ: ะตั ัะธะปะฐ ะฒะธะดะฝะฐ, ะบะพะณะดะฐ ะพะฝะฐ ะฒ ะณะพัััะตะน ะฒะพะดะต.ยป โ ะญะปะตะพะฝะพั ะัะทะฒะตะปัั",
    "ยซะะตะท ะปัะฑะฒะธ ะถะธะทะฝั โ ะฟัััะฐั ัะบะพัะปัะฟะฐ.ยป โ ะฅะฐะปะธะปั ะะถะตะฑัะฐะฝ",
    "ยซะะตัั ะฒ ัะตะฑั, ะธ ะฒะตัั ะผะธั ะฟะพะฒะตัะธั ะฒ ัะตะฑั.ยป โ ะะธัะดะถะธะฝะธั ะัะปั",
    "ยซะัะฐัะพัะฐ โ ััะพ ัะฒะตั ะฒ ัะตัะดัะต.ยป โ ะฅะฐะปะธะปั ะะถะตะฑัะฐะฝ",
    "ยซะัะฑะพะฒั โ ััะพ ะบะปัั ะบ ััะฐัััั.ยป โ ะัะดะดะฐ",
    "ยซะะตะฝัะธะฝะฐ ััะฐะฝะพะฒะธััั ะฝะตะฟะพะฑะตะดะธะผะพะน, ะบะพะณะดะฐ ะฒะตัะธั ะฒ ัะตะฑั.ยป โ ะะฟัะฐ ะฃะธะฝััะธ",
    "ยซะกัะฐััะปะธะฒะฐั ะถะตะฝัะธะฝะฐ โ ััะพ ัะธะปะฐ.ยป โ ะะธัะตะปั ะะฑะฐะผะฐ"
]

# === ะะปะฐะฒะธะฐัััั ===
main_keyboard = ReplyKeyboardMarkup(
    [["๐ ะกัะฐัั", "๐ ะฆะธัะฐัะฐ ะดะฝั"]],
    resize_keyboard=True
)

quote_keyboard = ReplyKeyboardMarkup(
    [["๐ค ะัะฟัะฐะฒะธัั ะฒ ะบะฐะฝะฐะป", "๐ ะััะณะฐั ัะธัะฐัะฐ"]],
    resize_keyboard=True
)

# === ะัะดะฐัะฐ ัะปััะฐะนะฝะพะน ัะธัะฐัั ===
def get_random_quote():
    return f"๐ _{random.choice(QUOTES)}_"

# === ะะฑัะฐะฑะพััะธะบะธ ===
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text("ะัะฑะตัะธัะต ะดะตะนััะฒะธะต:", reply_markup=main_keyboard)

async def send_quote(update: Update, context: ContextTypes.DEFAULT_TYPE):
    quote = get_random_quote()
    context.user_data["current_quote"] = quote
    await update.message.reply_markdown(quote, reply_markup=quote_keyboard)

async def send_to_channel(update: Update, context: ContextTypes.DEFAULT_TYPE):
    quote = context.user_data.get("current_quote", get_random_quote())
    await context.bot.send_message(chat_id=CHANNEL_ID, text=quote, parse_mode="Markdown")
    await update.message.reply_text("โ ะฆะธัะฐัะฐ ะพัะฟัะฐะฒะปะตะฝะฐ ะฒ ะบะฐะฝะฐะป.")

# === ะะฒัะพะผะฐัะธัะตัะบะฐั ะพัะฟัะฐะฒะบะฐ ะฒ ะบะฐะฝะฐะป ===
async def send_quote_to_channel(context: ContextTypes.DEFAULT_TYPE):
    quote = get_random_quote()
    await context.bot.send_message(chat_id=CHANNEL_ID, text=quote, parse_mode="Markdown")

# === ะัะฝะพะฒะฝะฐั ััะฝะบัะธั ===
async def main():
    app = ApplicationBuilder().token(TOKEN).build()

    app.add_handler(MessageHandler(filters.Regex("๐ ะกัะฐัั"), start))
    app.add_handler(MessageHandler(filters.Regex("๐ ะฆะธัะฐัะฐ ะดะฝั"), send_quote))
    app.add_handler(MessageHandler(filters.Regex("๐ค ะัะฟัะฐะฒะธัั ะฒ ะบะฐะฝะฐะป"), send_to_channel))
    app.add_handler(MessageHandler(filters.Regex("๐ ะััะณะฐั ัะธัะฐัะฐ"), send_quote))

    # ะะปะฐะฝะธัะพะฒัะธะบ ะฒะฝัััะธ event loop
    scheduler = AsyncIOScheduler()
    scheduler.add_job(send_quote_to_channel, "cron", hour=10, minute=0, args=[app])
    scheduler.start()

    if MODE == "webhook":
        await app.run_webhook(
            listen="0.0.0.0",
            port=PORT,
            url_path=TOKEN,
            webhook_url=f"{WEBHOOK_BASE}/{TOKEN}"
        )
    else:
        await app.run_polling()

if __name__ == "__main__":
    import asyncio
    asyncio.run(main())